# 폼 처리하기

## 1. HTML에서의 폼

- 일반적으로 사용자로부터 입력을 받기 위하여 폼`<form>...</form>`을 사용
- 폼에 입력된 데이터는 서버로 보내지며, 텍스트나 체크박스와 같은 간단한 폼은 기본 위젯을 사용하며, 달력, 슬라이드바 같이 복잡한 엘리먼트들은 JavaScript나 CSS를 사용하기도 함
- 폼은 `<input>` 엘리먼트 외에, 폼데이터를 어디로 보낼지 지정해주는 action 속성과, 어떤 HTML 메소드로 보낼지 지정하는 method 속성을 설정해 주어야 함
- HTTP 프로토콜 중 폼에서 사용할 수 있는 HTTP 메소드는 GET과 POST 뿐
- 서버 시스템의 상태를  바꾸는 요청(DB 내용을 변경하는 요청)은 POST 방식을 사용하고, 시스템의 상태를 바꾸지 않는 요청에는 GET 방식을 사용

## 2. 장고의 폼 기능

- 장고에서는 폼 처리를 위하여 다음 3가지 기능을 제공:

  > - 폼 생성에 필요한 데이터를 폼 클래스로 구조화
  > - 폼 클래스의 데이터를 렌더링하여 HTML 폼 만들기
  > - 사용자로부터 제출된 폼과 데이터를 수신하고 처리하기

- 장고의 폼 클래스의 필드는 HTML 폼의 `<input>` 엘리먼트와 매핑됨 (장고의 모델클래스가 DB 필드로 매핑되듯이)

- 폼 클래스의 필드는 폼 데이터를 저장하고 있으며, 폼이 제출되면 자신의 데이터에 대한 유효성 검사를 실시 (저장하는 데이터의 종류에 따라 자신의 타입을 갖게 됨)

- 폼도 결국은 템플릿의 일부로, 템플릿 코드에 포함되어 다음 3과정의 렌더링 절차를 거치게 됨

  > - 렌더링할 객체를 뷰로 가져오기 (예를 들어, DB로부터 객체를 추출)
  > - 객체를 템플릿 시스템으로 넘겨주기
  > - 템플릿 문법을 처리해서 HTML 마크업 언어로 변환하기

- 한가지 추가 고려사항은, 폼 객체는 사용자가 데이터를 채우는 것이 보통이므로 일반 템플릿과는 달리 데이터가 없을 수도 있음

## 3. 폼 클래스로 폼 생성

- 예시로 사용자의 이름을 취득하기 위한 폼을 아래와 같이 만든다고 가정:

  ```django
  <form action="/your-name/" method='post'>
      <label for="your_name">Your name: </label>
      <input id='your_name' type='text' name='your_name' value="{{ current_name }}">
      <input type='submit' value='OK'>
  </form>
  ```

- 위 예제는 POST 방식을 이용해서 브라우저에게 폼 데이터를 URL/your-name/으로 보내달라고 요청하고 있음

- `{{  current_name }}` 템플릿 변수는 템플릿 렌더링을 요청하는 뷰에서 변수값을 지정해 줄 것

- 폼이 제출되면 POST 요청에 폼데이터가 담겨서 서버로 보내지며, URL/your-name에서 해당하는 뷰를 확인 가능

- 장고는 이와 같은 `<form>` 엘리먼트 기능을 제공하기 위하여 아래와 같이 폼 클래스를 정의 (모든 폼 클래스는 **django.forms.Form**의 자식 클래스로 생성)

  ```python
  from django import forms
  
  class NameForm(forms.Form):
      your_name = forms.CharField(label="Your name", max_length=100)
  ```

- 위 예제는 필드가 your_name 하나인 폼 클래스임

- label 속성도 정의하여 렌더링 시 `<label>` 엘리먼트로 나타날 것

- 필드의 최대 길이도 max_length 속성으로 지정하여 `<input>`엘리먼트에  `maxlength="100"` 속성을 지정하며 데이터 유효성을 검증

- 각각의 폼 필드는 위젯 클래스를 갖고 있고, 위의 위젯 클래스는(CharField) 디폴트 위젯으로 **TextInput**을 사용

- 만약 디폴트 위젯을 `<textarea>`로 변경하려면 아래와 같이 위젯을 명시하면 됨

  ```python
  your_name = forms.CharField(label="Your name", max_length=100, widget=formss.Textarea)
  ```

- 참고로 장고의 폼 클래스는 모든 필드에 대해 유효성 검사 루틴을  실행하는 **`is_valid()`** 메소드를 갖고 있으며 다음과 같은 2가지 프로세스를 수행

  > - True를 반환
  > - 폼 데이터를 cleaned_data 속성에 추가

- 위의 폼 클래스가 템플릿 시스템에 의해 렌더링되면 다음과 같은 결과를 반환

  ```html
  <label for="your_name">Your name: </label>
  <input id="your_name" type="text" name="your_name" max_length=100>
  ```

- 렌더링 결과에 `<form>` 태그나 submit 버튼은 없는데, 이는 개발자가 직접 템플릿에 넣어주어야 함:

  ```django
  <form action="/your-name/" method="post">
      {% csrf_token %}
      {{ form }}
      <input type="submit" value="Submit"/>
  </form>
  ```

- CSRF 공격을 방지하기 위하여 `{% csrf_token %}`태그를 추가

- 폼 클래스는 `{{ form }}` 변수로 사용 (뷰에서 컨텍스트 변수에 포함하여 템플릿 시스템으로 반환)